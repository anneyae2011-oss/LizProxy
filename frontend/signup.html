<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Liz's Proxy - Complete your signup">
    <title>Sign Up - Liz's Proxy</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=Quicksand:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/static/style.css?v=20251227a">
</head>
<body>
    <!-- Background with Vignette -->
    <div class="background-image"></div>
    <div class="vignette-overlay"></div>
    
    <!-- Floating Particles -->
    <div class="particles-container">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <span class="icon-sun">‚òÄÔ∏è</span>
        <span class="icon-moon">üåô</span>
    </button>
    
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand-container">
            <a href="/" class="nav-brand">‚úß Liz's Proxy ‚úß</a>
            <span class="credits">credits to Maple AI</span>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">Home</a>
        </div>
    </nav>

    <main class="container">
        <div class="card">
            <!-- Header -->
            <header class="card-header">
                <h1>Almost There!</h1>
                <p class="subtitle">one more step to get your api key</p>
            </header>

            <!-- Email Display -->
            <section class="section">
                <div id="user-email" class="user-email" style="text-align: center; width: 100%; display: block;"></div>
            </section>

            <!-- RP Question Form -->
            <section class="section">
                <h2>Tell us about your RP</h2>
                <p class="info-text">What is your RP about and what is your most frequent style? (e.g., fantasy adventure, slice-of-life, action, romance, etc.)</p>
                
                <form id="signup-form" onsubmit="submitSignup(event)">
                    <div class="form-group">
                        <textarea
                            id="rp-application"
                            class="form-textarea"
                            placeholder="Describe what your RP is about and your most frequent style..."
                            rows="4"
                            required
                            maxlength="500"
                        ></textarea>
                        <div class="char-count">
                            <span id="char-count">0</span> / 500
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" id="submit-btn" class="btn btn-primary">
                            ‚úß Complete Signup ‚úß
                        </button>
                    </div>
                </form>
            </section>

            <!-- Status Messages -->
            <div id="status-message" class="status-message hidden"></div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>‚úß powered by liz's proxy ‚úß</p>
        </footer>
    </main>

    <script>
        // Get email from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email') || '';
        
        const userEmailEl = document.getElementById('user-email');
        const rpTextarea = document.getElementById('rp-application');
        const charCount = document.getElementById('char-count');
        const statusMessage = document.getElementById('status-message');
        const submitBtn = document.getElementById('submit-btn');
        
        // Display email
        if (email && userEmailEl) {
            userEmailEl.textContent = `Signing up as: ${decodeURIComponent(email)}`;
        }
        
        // Character counter
        rpTextarea.addEventListener('input', () => {
            charCount.textContent = rpTextarea.value.length;
        });
        
        // Submit signup
        async function submitSignup(event) {
            event.preventDefault();
            
            const rpText = rpTextarea.value.trim();
            if (!rpText) {
                showStatus('Please tell us about your RP and your most frequent style.', 'error');
                return;
            }
            
            // Disable button while submitting
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                const response = await fetch('/auth/complete-signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ rp_application: rpText }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const message = errorData.detail || 'Signup failed. Please try again.';
                    showStatus(message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úß Complete Signup ‚úß';
                    return;
                }
                
                const data = await response.json();
                
                if (data.existing) {
                    // Existing user ‚Äî redirect home
                    window.location.href = `/?key_prefix=${data.key_prefix}&existing=true&email=${encodeURIComponent(data.email || '')}`;
                } else if (data.pending_approval) {
                    // New user ‚Äî account pending admin approval
                    // Store key locally so it's available once approved
                    localStorage.setItem('ai_proxy_full_key', data.key);
                    localStorage.setItem('ai_proxy_key_prefix', data.key_prefix);
                    
                    // Show pending approval message
                    document.getElementById('signup-form').style.display = 'none';
                    showPendingApproval(data.email);
                } else {
                    // New user ‚Äî redirect with key (auto-approved)
                    localStorage.setItem('ai_proxy_full_key', data.key);
                    localStorage.setItem('ai_proxy_key_prefix', data.key_prefix);
                    window.location.href = `/?key=${encodeURIComponent(data.key)}&key_prefix=${data.key_prefix}&new=true&email=${encodeURIComponent(data.email || '')}`;
                }
            } catch (error) {
                console.error('Signup error:', error);
                showStatus('Network error. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úß Complete Signup ‚úß';
            }
        }
        
        function showPendingApproval(email) {
            // Replace the form section with a pending approval message
            const card = document.querySelector('.card');
            const sections = card.querySelectorAll('.section');
            sections.forEach(s => s.style.display = 'none');
            
            // Update header
            const header = card.querySelector('.card-header');
            header.querySelector('h1').textContent = 'Application Submitted!';
            header.querySelector('.subtitle').textContent = 'waiting for admin approval';
            
            // Create pending message
            const pendingDiv = document.createElement('section');
            pendingDiv.className = 'section';
            pendingDiv.innerHTML = `
                <div class="pending-approval-message">
                    <div class="pending-icon">‚è≥</div>
                    <h2>Your account is pending approval</h2>
                    <p class="info-text">
                        Thank you for signing up${email ? ` as <strong>${email}</strong>` : ''}!
                        Your application has been submitted and your account will be reviewed by an admin.
                    </p>
                    <p class="info-text">
                        Once approved, your API key will be activated and you'll be able to use the proxy.
                        You can check back later by signing in again.
                    </p>
                    <a href="/" class="btn btn-ghost" style="margin-top: 1rem; display: inline-block; text-decoration: none;">
                        ‚úß Return Home ‚úß
                    </a>
                </div>
            `;
            header.after(pendingDiv);
        }
        
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }
        
        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('ai_proxy_theme', newTheme);
        }
        
        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('ai_proxy_theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        }
        
        loadTheme();
    </script>
</body>
</html>
